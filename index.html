<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <title>モバイルオーダー（注文）</title>
        <style>
            :root {
                --bg: #f7f7fb;
                --card: #fff;
                --text: #121826;
                --muted: #4b5563; /* コントラストをやや強めに */
                --border: #e6e7ec;
                --accent: #2563eb;
                --ring: 0 0 0 3px rgba(37, 99, 235, 0.25);
                --action-h: 80px;
                --action-gap: 24px;

                /* ピッカー/シート用 */
                --row: 44px;
                --wheel-h: 220px;
                --sheet-radius: 16px;
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            html {
                font-size: 16px;
                scroll-padding-bottom: calc(
                    var(--action-h) + var(--action-gap) +
                        env(safe-area-inset-bottom)
                );
            }
            body {
                margin: 0;
                background: var(--bg);
                color: var(--text);
                font-family:
                    system-ui,
                    -apple-system,
                    "Segoe UI",
                    Roboto,
                    "Helvetica Neue",
                    Arial,
                    sans-serif;
                -webkit-text-size-adjust: 100%;
                -webkit-tap-highlight-color: transparent;
                padding: 0 16px 16px;
                padding-top: calc(
                    16px + env(safe-area-inset-top)
                ); /* Safe Area 上側も考慮 */
                line-height: 1.5;
                font-feature-settings:
                    "tnum" 1,
                    "cv01" 1;
            }
            body.no-scroll {
                overflow: hidden; /* モーダル表示中は本体スクロールを抑止 */
            }
            .container {
                width: 100%;
                max-width: 640px;
                margin: 0 auto;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            h1 {
                margin: 0;
                font-size: clamp(18px, 4.5vw, 22px);
                font-weight: 800;
                letter-spacing: 0.01em;
            }
            .sub {
                margin-top: 4px;
                color: var(--muted);
                font-size: 0.92rem;
            }

            /* お知らせ（全品売切れ） */
            .notice {
                background: #fff7ed;
                color: #9a3412;
                border: 1px solid #fed7aa;
                border-radius: 12px;
                padding: 10px 12px;
            }
            .notice[hidden] {
                display: none;
            }

            /* 商品リスト */
            .list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .item {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 8px 12px;
                align-items: center;
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 12px;
            }
            .item--soldout {
                opacity: 0.85;
            }
            .info {
                min-width: 0;
            }
            .name {
                font-weight: 700;
                line-height: 1.3;
                word-break: break-word;
                overflow-wrap: anywhere;
            }
            .meta {
                margin-top: 6px;
                color: var(--muted);
                font-size: 0.95rem;
            }
            .price {
                font-weight: 800;
            }
            .sold {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 12px;
                border-radius: 999px;
                background: #fee2e2;
                color: #991b1b;
                border: 1px solid #fecaca;
                font-weight: 800;
                white-space: nowrap;
            }

            /* ステッパー */
            .stepper {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .btn {
                appearance: none;
                border: 1px solid var(--border);
                background: #fff;
                color: var(--text);
                width: 44px;
                height: 44px; /* 44px 四方で統一 */
                border-radius: 999px;
                font-size: 20px;
                line-height: 1;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.05s ease;
            }
            .btn:active {
                transform: translateY(1px);
            }
            .btn:focus-visible {
                outline: none;
                box-shadow: var(--ring);
            }
            .btn[disabled] {
                opacity: 0.45;
                cursor: not-allowed;
            }
            .num {
                width: 76px;
                min-height: 44px;
                text-align: center;
                font-size: 1rem;
                padding: 10px 8px;
                border: 1px solid var(--border);
                border-radius: 10px;
                background: #fff;
                color: var(--text);
                outline: none;
                scroll-margin-bottom: calc(var(--action-h) + var(--action-gap));
            }
            .num:focus-visible {
                box-shadow: var(--ring);
            }
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type="number"] {
                -moz-appearance: textfield;
            }

            /* 座席番号（インライン表示＋ローラーピッカー起動） */
            .field {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .field label {
                color: var(--muted);
            }
            .input-like {
                width: 100%;
                min-height: 68px; /* メニュー行と高さあわせ（見た目のボリューム） */
                font-size: 1rem;
                padding: 12px; /* メニューカードと同じ内側余白 */
                background: #fff;
                color: var(--text);
                border: 1px solid var(--border);
                border-radius: 12px; /* メニューカードと同じ角丸 */
                outline: none;
                text-align: left;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                cursor: pointer;
            }
            .input-like:focus-visible {
                box-shadow: var(--ring);
            }
            /* 座席エラー表示用の装飾 */
            .input-like--error {
                border-color: #ef4444;
                box-shadow: inset 0 0 0 2px rgba(239, 68, 68, 0.12);
            }
            .field-error {
                color: #b91c1c; /* 赤字 */
                font-size: 0.92rem;
                margin-top: 4px;
            }

            .muted {
                color: var(--muted);
            }

            /* サマリー行表示用 */
            .p-body {
                display: grid;
                gap: 8px;
            }
            .brief-list {
                display: grid;
                gap: 6px;
            }
            .row-brief {
                display: grid;
                grid-template-columns: 1fr auto auto;
                gap: 6px 12px;
                align-items: baseline;
                border-bottom: 1px dashed #e5e7eb;
                padding: 6px 0;
            }
            .row-brief:last-child {
                border-bottom: none;
            }
            .brief-name {
                font-weight: 700;
            }
            .brief-qty {
                color: var(--muted);
            }
            .brief-price {
                color: var(--muted);
            }
            .sumline {
                text-align: right;
                font-weight: 800;
                margin-top: 2px;
            }
            .hint {
                color: var(--muted);
                font-size: 0.95rem;
            }

            /* 固定アクションバー（共通） */
            .action {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: max(16px, env(safe-area-inset-bottom));
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 10px 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
                z-index: 50;
            }
            .summary {
                font-weight: 800;
                white-space: nowrap;
            }
            .summary [data-amount] {
                font-variant-numeric: tabular-nums;
            }
            .primary {
                appearance: none;
                border: none;
                background: var(--accent);
                color: #fff;
                padding: 0 18px;
                min-height: 44px; /* 統一 */
                border-radius: 999px;
                font-size: 1rem;
                cursor: pointer;
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            .primary:disabled {
                opacity: 0.8;
                cursor: default; /* 常にノーマルカーソル */
                box-shadow: none;
            }

            /* 下スペーサー（固定バー分の余白） */
            .bottom-spacer {
                height: calc(
                    var(--action-h) + var(--action-gap) +
                        env(safe-area-inset-bottom)
                );
            }

            /* ボトムシート（iOSピッカー風・確認/完了も同レイアウト） */
            .sheet {
                position: fixed;
                inset: 0;
                z-index: 100;
                pointer-events: none;
            }
            .sheet[hidden] {
                display: none;
            }
            .sheet__backdrop {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.35);
                opacity: 0;
                transition: opacity 160ms ease;
            }
            .sheet__panel {
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                transform: translateY(100%);
                background: var(--card);
                border-top-left-radius: var(--sheet-radius);
                border-top-right-radius: var(--sheet-radius);
                border: 1px solid var(--border);
                border-bottom: none;
                box-shadow: 0 -16px 48px rgba(0, 0, 0, 0.18);
                transition: transform 200ms ease;
                display: grid;
                grid-template-rows: auto 1fr auto;
                gap: 0;
                pointer-events: auto;
                max-height: 85vh;
            }
            .sheet--open .sheet__backdrop {
                opacity: 1;
            }
            .sheet--open .sheet__panel {
                transform: translateY(0%);
            }
            .sheet__header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 12px;
                border-bottom: 1px solid var(--border);
                gap: 8px;
                min-height: 64px; /* ヘッダーの高さを全シートで統一 */
            }
            .sheet__title {
                font-weight: 800;
            }
            .sheet__actions {
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            .sheet__content {
                overflow: auto;
                padding: 12px 14px;
                display: grid;
                gap: 10px;
            }
            .sheet__footer {
                padding: 10px 12px;
                border-top: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 8px;
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
            .btn--ghost {
                appearance: none;
                border: 1px solid var(--border);
                background: #fff;
                color: var(--text);
                padding: 0 14px;
                min-height: 44px; /* 高さを統一 */
                border-radius: 999px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 1rem; /* フォントサイズを .primary と統一 */
            }

            /* ピッカー固有（座席） */
            .sheet__wheels {
                position: relative;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                padding: 12px 14px;
            }
            .wheel {
                position: relative;
                height: var(--wheel-h);
                overflow: hidden;
                border: 1px solid var(--border);
                border-radius: 12px;
                background: #fff;
            }
            .wheel__list {
                height: 100%;
                overflow: auto;
                scroll-snap-type: y mandatory;
                -webkit-overflow-scrolling: touch;
                padding-top: calc((var(--wheel-h) - var(--row)) / 2);
                padding-bottom: calc((var(--wheel-h) - var(--row)) / 2);
                margin: 0;
            }
            .wheel__item {
                height: var(--row);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.15rem;
                scroll-snap-align: center;
                user-select: none;
            }
            .wheel__item.selected {
                font-weight: 800;
                color: var(--accent);
            }
            .indicator {
                position: absolute;
                left: 14px;
                right: 14px;
                top: 50%;
                transform: translateY(-50%);
                height: var(--row);
                pointer-events: none;
                border-top: 1px solid #e5e7eb;
                border-bottom: 1px solid #e5e7eb;
                border-radius: 6px;
            }
            .seat-note {
                color: var(--muted);
            }

            /* 注文履歴リンクと履歴UI */
            .history-link {
                appearance: none;
                background: none;
                border: none;
                color: var(--muted);
                padding: 8px 12px; /* タッチ領域拡大 */
                font-size: 0.9rem;
                /* 罫線を下線に変更し、文字との距離を近くする */
                text-decoration: underline;
                text-underline-offset: 2px;
                text-decoration-thickness: 1px;
                cursor: pointer;
                align-self: center; /* 中央揃え */
                min-height: 44px; /* タッチ領域確保 */
            }
            .history-list {
                display: grid;
                gap: 10px;
            }
            .h-item {
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 10px 12px;
                background: #fff;
            }
            .h-head {
                display: flex;
                align-items: baseline;
                justify-content: space-between;
                gap: 10px;
                margin-bottom: 6px;
                border-bottom: 1px dashed #e5e7eb;
                padding-bottom: 6px;
            }
            .h-seat {
                font-weight: 800;
            }
            .h-meta {
                color: var(--muted);
                font-size: 0.9rem;
                white-space: nowrap;
            }
            .h-empty {
                color: var(--muted);
            }

            /* スケルトンローディング */
            .skeleton-card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 12px;
            }
            .skeleton {
                position: relative;
                overflow: hidden;
                background: #e5e7eb;
                border-radius: 6px;
            }
            .skeleton::after {
                content: "";
                position: absolute;
                inset: 0;
                transform: translateX(-100%);
                background: linear-gradient(
                    90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.6) 50%,
                    rgba(255, 255, 255, 0) 100%
                );
                animation: shimmer 1.2s infinite;
            }
            @keyframes shimmer {
                100% {
                    transform: translateX(100%);
                }
            }

            /* 簡易スピナー */
            .spinner {
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255, 255, 255, 0.7);
                border-right-color: transparent;
                border-radius: 50%;
                display: inline-block;
                animation: spin 0.8s linear infinite;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div>
                    <h1>ご注文</h1>
                    <div class="sub">数量を入力して「注文する」をタップ</div>
                </div>
            </header>

            <div id="notice" class="notice" hidden aria-live="polite"></div>

            <!-- 通常のメニュー一覧 -->
            <div id="list" class="list" aria-live="polite"></div>

            <!-- 座席 -->
            <div id="seatField" class="field">
                <label for="seatOpen">座席番号</label>
                <button
                    id="seatOpen"
                    class="input-like"
                    type="button"
                    aria-haspopup="dialog"
                    aria-controls="seatSheet"
                >
                    <span id="seatDisplay" class="muted">座席を選択</span>
                </button>
                <input id="seat" type="hidden" />
                <!-- 座席未入力時のエラー表示（赤字） -->
                <div
                    id="seatError"
                    class="field-error"
                    role="alert"
                    aria-live="polite"
                    hidden
                >
                    座席番号を選択してください。
                </div>
            </div>

            <!-- 注文履歴リンク（弱い見出し扱い。上下余白を確保） -->
            <button
                id="historyOpen"
                class="history-link"
                type="button"
                aria-haspopup="dialog"
                aria-controls="historySheet"
                style="margin-top: 4px"
            >
                注文履歴
            </button>

            <div id="result" class="msg" aria-live="polite"></div>

            <div class="bottom-spacer" aria-hidden="true"></div>
        </div>

        <!-- 座席ピッカー（基準UI：タイトル左／右にクリア＋完了／下に閉じる） -->
        <div
            id="seatSheet"
            class="sheet"
            role="dialog"
            aria-modal="true"
            aria-labelledby="seatTitle"
            aria-hidden="true"
            hidden
        >
            <div class="sheet__backdrop" id="seatBackdrop"></div>
            <div class="sheet__panel" role="document">
                <div class="sheet__header">
                    <div class="sheet__title" id="seatTitle">座席を選択</div>
                    <div class="sheet__actions">
                        <button id="seatClear" class="btn--ghost" type="button">
                            クリア
                        </button>
                        <button
                            id="seatDone"
                            class="primary"
                            type="button"
                            disabled
                        >
                            完了
                        </button>
                    </div>
                </div>
                <div class="sheet__wheels">
                    <div class="wheel">
                        <div class="wheel__list" id="wheelArea"></div>
                    </div>
                    <div class="wheel">
                        <div class="wheel__list" id="wheelNum"></div>
                    </div>
                    <div class="indicator" aria-hidden="true"></div>
                </div>
                <div class="sheet__footer">
                    <button id="seatCancel" class="btn--ghost" type="button">
                        閉じる
                    </button>
                </div>
            </div>
        </div>

        <!-- 注文内容の確認（座席シートと同レイアウト：右上に確定、下に戻る） -->
        <div
            id="confirmSheet"
            class="sheet"
            role="dialog"
            aria-modal="true"
            aria-labelledby="confirmTitle"
            aria-hidden="true"
            hidden
        >
            <div class="sheet__backdrop" id="confirmBackdrop"></div>
            <div class="sheet__panel" role="document">
                <div class="sheet__header">
                    <div class="sheet__title" id="confirmTitle">
                        注文内容の確認
                    </div>
                    <div class="sheet__actions">
                        <button id="confirmOk" class="primary" type="button">
                            注文を確定する
                        </button>
                    </div>
                </div>
                <div class="sheet__content">
                    <div class="seat-note" id="confirmSeat"></div>
                    <div class="p-body" style="margin-top: 6px">
                        <div id="confirmList" class="brief-list"></div>
                    </div>
                </div>
                <div class="sheet__footer">
                    <button id="confirmBack" class="btn--ghost" type="button">
                        戻る
                    </button>
                </div>
            </div>
        </div>

        <!-- 注文完了（右下＝閉じる／背景タップで閉じるに整理） -->
        <div
            id="resultSheet"
            class="sheet"
            role="dialog"
            aria-modal="true"
            aria-labelledby="resultTitle"
            aria-hidden="true"
            hidden
        >
            <div class="sheet__backdrop" id="resultBackdrop"></div>
            <div class="sheet__panel" role="document">
                <div class="sheet__header">
                    <div class="sheet__title" id="resultTitle">
                        ご注文ありがとうございました
                    </div>
                    <div class="sheet__actions">
                        <!-- 右上ボタンを削除し、重複を整理 -->
                    </div>
                </div>
                <div class="sheet__content">
                    <div class="seat-note" id="resultSeat"></div>
                    <div class="hint" style="margin-top: 6px">
                        注文を準備しております。まもなくスタッフがお届けしますので、代金をご用意の上、少々お待ちください。
                    </div>
                    <div class="p-body" style="margin-top: 6px">
                        <div id="resultList" class="brief-list"></div>
                    </div>
                </div>
                <div class="sheet__footer">
                    <button id="resultClose" class="btn--ghost" type="button">
                        閉じる
                    </button>
                </div>
            </div>
        </div>

        <!-- 注文履歴（表示のみ。右上＝全消去／下＝閉じる） -->
        <div
            id="historySheet"
            class="sheet"
            role="dialog"
            aria-modal="true"
            aria-labelledby="historyTitle"
            aria-hidden="true"
            hidden
        >
            <div class="sheet__backdrop" id="historyBackdrop"></div>
            <div class="sheet__panel" role="document">
                <div class="sheet__header">
                    <div class="sheet__title" id="historyTitle">注文履歴</div>
                    <div class="sheet__actions">
                        <button
                            id="historyClear"
                            class="btn--ghost"
                            type="button"
                        >
                            履歴を削除
                        </button>
                    </div>
                </div>
                <div class="sheet__content">
                    <div id="historyList" class="history-list"></div>
                </div>
                <div class="sheet__footer">
                    <button id="historyClose" class="btn--ghost" type="button">
                        閉じる
                    </button>
                </div>
            </div>
        </div>

        <!-- 入力用 下部バー -->
        <div
            class="action"
            id="actionBar"
            role="region"
            aria-label="注文の合計"
        >
            <div class="summary" aria-live="polite">
                <span id="count">0</span> 点 / 合計
                <span id="total" data-amount>¥0</span>
            </div>
            <button id="submitBtn" class="primary" disabled>注文する</button>
        </div>

        <script>
            const API_BASE =
                "https://script.google.com/macros/s/AKfycbx13V768FI1C79iewAv8q5j5dp-EB1gOzh0UurwnGnEoEiud8cpzSBmAeALs8HW8R893w/exec"; // ←置き換え

            const list = document.getElementById("list");
            const notice = document.getElementById("notice");

            const seatEl = document.getElementById("seat");
            const seatOpen = document.getElementById("seatOpen");
            const seatDisplay = document.getElementById("seatDisplay");
            const seatError = document.getElementById("seatError");
            const seatField = document.getElementById("seatField");

            // 座席シート
            const seatSheet = document.getElementById("seatSheet");
            const seatBackdrop = document.getElementById("seatBackdrop");
            const seatDone = document.getElementById("seatDone");
            const seatCancel = document.getElementById("seatCancel");
            const seatClear = document.getElementById("seatClear");
            const wheelArea = document.getElementById("wheelArea");
            const wheelNum = document.getElementById("wheelNum");

            // 確認シート
            const confirmSheet = document.getElementById("confirmSheet");
            const confirmBackdrop = document.getElementById("confirmBackdrop");
            const confirmSeat = document.getElementById("confirmSeat");
            const confirmList = document.getElementById("confirmList");
            const confirmBack = document.getElementById("confirmBack");
            const confirmOk = document.getElementById("confirmOk");

            // 完了シート
            const resultSheet = document.getElementById("resultSheet");
            const resultBackdrop = document.getElementById("resultBackdrop");
            const resultSeat = document.getElementById("resultSeat");
            const resultList = document.getElementById("resultList");
            const resultClose = document.getElementById("resultClose");

            // 履歴
            const historyOpen = document.getElementById("historyOpen");
            const historySheet = document.getElementById("historySheet");
            const historyBackdrop = document.getElementById("historyBackdrop");
            const historyClose = document.getElementById("historyClose");
            const historyClear = document.getElementById("historyClear");
            const historyList = document.getElementById("historyList");

            const actionBar = document.getElementById("actionBar");
            const submitBtn = document.getElementById("submitBtn");
            const resultMsg = document.getElementById("result");
            const countEl = document.getElementById("count");
            const totalEl = document.getElementById("total");

            const pad2 = (n) => String(n).padStart(2, "0");
            const AREAS = [
                "A",
                "B",
                "C",
                "D",
                "E",
                "F",
                "G",
                "H",
                "I",
                "J",
                "K",
            ];
            const NUMS = Array.from({ length: 21 }, (_, i) => pad2(i + 1));

            const ROW_H = 44;
            let tmpArea = null;
            let tmpNum = null;
            let scrollTimers = new Map();
            let lastOrderSnapshot = null;

            const LAST_SEAT_KEY = "mo.lastSeat.v1";

            const yen = (n) => "¥" + Number(n || 0).toLocaleString("ja-JP");

            // 固定バー高さをCSS変数に反映
            new ResizeObserver(() => {
                const h = actionBar.offsetHeight || 80;
                document.documentElement.style.setProperty(
                    "--action-h",
                    h + "px",
                );
            }).observe(actionBar);

            /* スケルトン描画 */
            function renderMenuSkeleton() {
                list.innerHTML = "";
                for (let i = 0; i < 3; i++) {
                    const card = document.createElement("div");
                    card.className = "skeleton-card";
                    const line1 = document.createElement("div");
                    line1.className = "skeleton";
                    line1.style.height = "18px";
                    line1.style.width = "60%";
                    const line2 = document.createElement("div");
                    line2.className = "skeleton";
                    line2.style.height = "14px";
                    line2.style.width = "40%";
                    line2.style.marginTop = "10px";
                    card.append(line1, line2);
                    list.append(card);
                }
            }

            /* メニュー描画 */
            function renderMenu(items) {
                list.innerHTML = "";
                notice.hidden = true;
                notice.textContent = "";

                if (!items || !items.length) {
                    const div = document.createElement("div");
                    div.className = "msg";
                    div.textContent = "現在ご注文いただける商品がありません。";
                    list.append(div);
                    submitBtn.disabled = true;
                    return;
                }

                const anyActive = items.some((it) => !!it.active);
                if (!anyActive) {
                    notice.hidden = false;
                    notice.textContent =
                        "モバイルオーダーは試合開始後に受け付けます。";
                }

                for (const it of items) {
                    const row = document.createElement("div");
                    row.className =
                        "item" + (it.active ? "" : " item--soldout");
                    row.dataset.itemId = it.id;
                    row.dataset.price = it.price;
                    row.dataset.active = String(!!it.active);

                    const info = document.createElement("div");
                    info.className = "info";
                    info.innerHTML = `<div class="name">${it.name}</div>
            <div class="meta"><span class="price">${yen(it.price)}</span>（税込）</div>`;

                    const right = document.createElement("div");

                    if (it.active) {
                        const stepper = document.createElement("div");
                        stepper.className = "stepper";

                        const minus = document.createElement("button");
                        minus.type = "button";
                        minus.className = "btn";
                        minus.textContent = "−";
                        minus.setAttribute(
                            "aria-label",
                            it.name + " を1つ減らす",
                        );
                        minus.disabled = true;

                        const input = document.createElement("input");
                        input.className = "num";
                        input.type = "number";
                        input.min = "0";
                        input.max = "10"; /* 最大10個まで */
                        input.step = "1";
                        input.value = "0";
                        input.inputMode = "numeric";
                        input.setAttribute("aria-label", it.name + " の数量");

                        const plus = document.createElement("button");
                        plus.type = "button";
                        plus.className = "btn";
                        plus.textContent = "+";
                        plus.setAttribute(
                            "aria-label",
                            it.name + " を1つ増やす",
                        );

                        const clampQty = (v) => {
                            v = parseInt(
                                String(v).replace(/[^\d]/g, "") || "0",
                                10,
                            );
                            if (!Number.isFinite(v)) v = 0;
                            v = Math.max(0, Math.min(10, v));
                            return v;
                        };

                        const setQty = (v) => {
                            v = clampQty(v);
                            input.value = String(v);
                            minus.disabled = v <= 0;
                            updateSummary();
                        };
                        minus.addEventListener("click", () =>
                            setQty((parseInt(input.value || "0", 10) || 0) - 1),
                        );
                        plus.addEventListener("click", () =>
                            setQty((parseInt(input.value || "0", 10) || 0) + 1),
                        );
                        input.addEventListener("input", () =>
                            setQty(input.value),
                        );
                        input.addEventListener("blur", () =>
                            setQty(input.value),
                        );
                        input.addEventListener("keydown", (e) => {
                            if (e.key === "ArrowUp") {
                                e.preventDefault();
                                setQty(
                                    (parseInt(input.value || "0", 10) || 0) + 1,
                                );
                            } else if (e.key === "ArrowDown") {
                                e.preventDefault();
                                setQty(
                                    (parseInt(input.value || "0", 10) || 0) - 1,
                                );
                            }
                        });

                        stepper.append(minus, input, plus);
                        right.append(stepper);
                    } else {
                        const sold = document.createElement("span");
                        sold.className = "sold";
                        sold.textContent = "売切れ";
                        right.append(sold);
                    }

                    row.append(info, right);
                    list.append(row);
                }
                updateSummary();
            }

            function collectOrderDetailed() {
                const items = [];
                list.querySelectorAll(".item").forEach((r) => {
                    const active = r.dataset.active === "true";
                    if (!active) return;
                    const qty = parseInt(
                        r.querySelector(".num").value || "0",
                        10,
                    );
                    if (qty > 0) {
                        const name =
                            r.querySelector(".name")?.textContent?.trim() || "";
                        const price = Number(r.dataset.price);
                        items.push({
                            itemId: r.dataset.itemId,
                            name,
                            quantity: qty,
                            price,
                            total: price * qty,
                        });
                    }
                });
                return items;
            }
            function collectOrderPayload() {
                return collectOrderDetailed().map((x) => ({
                    itemId: x.itemId,
                    quantity: x.quantity,
                }));
            }
            function updateSummary() {
                const items = collectOrderDetailed();
                const count = items.reduce((s, x) => s + x.quantity, 0);
                const total = items.reduce((s, x) => s + x.total, 0);
                countEl.textContent = count;
                totalEl.textContent = yen(total);
                // 座席未入力でもクリックできる（警告表示のため）
                submitBtn.disabled = count === 0;
                // 数量が0ならエラーは隠す（操作の誘導を減らすため）
                if (count === 0) {
                    hideSeatError();
                }
            }

            /* シート開閉とアクセシビリティ：フォーカス保持・トラップ・Esc対応 */
            let activeSheet = null;
            let activeTrigger = null;
            let keydownHandler = null;

            function getFocusableElements(container) {
                return Array.from(
                    container.querySelectorAll(
                        'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])',
                    ),
                ).filter(
                    (el) =>
                        el.offsetParent !== null || el.getClientRects().length,
                );
            }

            function openSheet(sheet, triggerEl, initialFocusEl) {
                activeSheet = sheet;
                activeTrigger = triggerEl || null;

                sheet.hidden = false;
                sheet.setAttribute("aria-hidden", "false");
                requestAnimationFrame(() => {
                    sheet.classList.add("sheet--open");
                    document.body.classList.add("no-scroll");

                    // フォーカス移動
                    const target =
                        initialFocusEl ||
                        getFocusableElements(sheet)[0] ||
                        sheet.querySelector(".sheet__panel");
                    if (target && target.focus) {
                        setTimeout(() => target.focus(), 0);
                    }

                    // キーハンドラ（Tabトラップ＋Esc）
                    keydownHandler = (e) => {
                        if (!activeSheet) return;
                        if (e.key === "Escape") {
                            e.preventDefault();
                            closeSheet(activeSheet);
                            return;
                        }
                        if (e.key === "Tab") {
                            const focusables =
                                getFocusableElements(activeSheet);
                            if (!focusables.length) return;
                            const first = focusables[0];
                            const last = focusables[focusables.length - 1];
                            const current = document.activeElement;

                            if (e.shiftKey) {
                                if (
                                    current === first ||
                                    !activeSheet.contains(current)
                                ) {
                                    e.preventDefault();
                                    last.focus();
                                }
                            } else {
                                if (current === last) {
                                    e.preventDefault();
                                    first.focus();
                                }
                            }
                        }
                    };
                    document.addEventListener("keydown", keydownHandler);
                });
            }

            function closeSheet(sheet) {
                if (!sheet) sheet = activeSheet;
                if (!sheet) return;
                sheet.classList.remove("sheet--open");
                sheet.setAttribute("aria-hidden", "true");
                document.body.classList.remove("no-scroll");
                setTimeout(() => {
                    sheet.hidden = true;
                }, 200);

                if (keydownHandler) {
                    document.removeEventListener("keydown", keydownHandler);
                    keydownHandler = null;
                }

                // フォーカス返却
                if (activeTrigger && activeTrigger.focus) {
                    setTimeout(() => activeTrigger.focus(), 0);
                }
                activeSheet = null;
                activeTrigger = null;
            }

            /* 座席ピッカー */
            function makeWheelItems(el, values) {
                el.innerHTML = "";
                values.forEach((v) => {
                    const d = document.createElement("div");
                    d.className = "wheel__item";
                    d.dataset.value = v;
                    d.textContent = v;
                    el.appendChild(d);
                });
            }
            function setSelectedClass(el, index) {
                const items = el.querySelectorAll(".wheel__item");
                items.forEach((it, i) =>
                    it.classList.toggle("selected", i === index),
                );
            }
            function nearestIndex(el) {
                const t = el.scrollTop;
                return Math.max(
                    0,
                    Math.min(el.children.length - 1, Math.round(t / ROW_H)),
                );
            }
            function scrollToIndex(el, index, behavior = "smooth") {
                el.scrollTo({ top: index * ROW_H, behavior });
            }
            function handleScroll(el, onChange) {
                if (scrollTimers.get(el)) clearTimeout(scrollTimers.get(el));
                const idx = nearestIndex(el);
                setSelectedClass(el, idx);
                scrollTimers.set(
                    el,
                    setTimeout(() => {
                        const ni = nearestIndex(el);
                        scrollToIndex(el, ni, "smooth");
                        if (onChange) onChange(el.children[ni].dataset.value);
                    }, 80),
                );
            }
            function initWheel(el, values, currentValue, onChange) {
                makeWheelItems(el, values);
                let startIdx = 0;
                if (currentValue) {
                    const i = values.indexOf(currentValue);
                    if (i >= 0) startIdx = i;
                }
                scrollToIndex(el, startIdx, "auto");
                setSelectedClass(el, startIdx);
                if (onChange) onChange(values[startIdx]);
                el.addEventListener(
                    "scroll",
                    () => handleScroll(el, onChange),
                    {
                        passive: true,
                    },
                );
                el.addEventListener("click", (e) => {
                    const item = e.target.closest(".wheel__item");
                    if (!item) return;
                    const idx = Array.from(el.children).indexOf(item);
                    scrollToIndex(el, idx, "smooth");
                    setSelectedClass(el, idx);
                    if (onChange) onChange(item.dataset.value);
                });
            }

            function openSeatSheet() {
                const cur = seatEl.value.trim();
                let curA = null,
                    curN = null;
                const m = /^([A-K])\-(\d{2})$/.exec(cur);
                if (m) {
                    curA = m[1];
                    curN = m[2];
                }
                tmpArea = curA || AREAS[0];
                tmpNum = curN || NUMS[0];

                initWheel(wheelArea, AREAS, tmpArea, (v) => {
                    tmpArea = v;
                    seatDone.disabled = !(tmpArea && tmpNum);
                });
                initWheel(wheelNum, NUMS, tmpNum, (v) => {
                    tmpNum = v;
                    seatDone.disabled = !(tmpArea && tmpNum);
                });

                seatDone.disabled = !(tmpArea && tmpNum);
                openSheet(seatSheet, seatOpen, seatDone);
            }
            function closeSeatSheet() {
                closeSheet(seatSheet);
            }

            seatOpen.addEventListener("click", openSeatSheet);
            seatBackdrop.addEventListener("click", closeSeatSheet);
            seatCancel.addEventListener("click", closeSeatSheet);
            seatClear.addEventListener("click", () => {
                tmpArea = null;
                tmpNum = null;
                seatEl.value = "";
                seatDisplay.textContent = "座席を選択";
                seatDisplay.classList.add("muted");
                seatDone.disabled = true;
                updateSummary();
                scrollToIndex(wheelArea, 0, "smooth");
                setSelectedClass(wheelArea, 0);
                scrollToIndex(wheelNum, 0, "smooth");
                setSelectedClass(wheelNum, 0);
            });
            seatDone.addEventListener("click", () => {
                if (!(tmpArea && tmpNum)) return;
                const seatStr = `${tmpArea}-${tmpNum}`;
                seatEl.value = seatStr;
                seatDisplay.textContent = `座席 ${seatStr}`;
                seatDisplay.classList.remove("muted");
                // 直前の座席を保存
                try {
                    localStorage.setItem(LAST_SEAT_KEY, seatStr);
                } catch (e) {}
                hideSeatError();
                updateSummary();
                closeSeatSheet();
            });

            function showSeatError() {
                seatError.hidden = false;
                seatOpen.classList.add("input-like--error");
                // 視線誘導：座席UIへスクロール
                seatField.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                });
                // フォーカス
                seatOpen.focus();
            }
            function hideSeatError() {
                seatError.hidden = true;
                seatOpen.classList.remove("input-like--error");
            }

            /* サマリー構築（確認/完了で共用） */
            function buildSummary(container, snapshotItems) {
                const items = snapshotItems || collectOrderDetailed();
                container.innerHTML = "";
                items.forEach((it) => {
                    const r = document.createElement("div");
                    r.className = "row-brief";
                    const n = document.createElement("div");
                    n.className = "brief-name";
                    n.textContent = it.name;
                    const q = document.createElement("div");
                    q.className = "brief-qty";
                    q.textContent = `×${it.quantity}`;
                    const p = document.createElement("div");
                    p.className = "brief-price";
                    p.textContent = yen(it.total);
                    r.append(n, q, p);
                    container.append(r);
                });
                const total = items.reduce((s, x) => s + x.total, 0);
                const sum = document.createElement("div");
                sum.className = "sumline";
                sum.textContent = `合計 ${yen(total)}`;
                container.append(sum);
            }

            /* 履歴ユーティリティ */
            const HISTORY_LS_KEY = "mo.orderHistory.v1";
            const HISTORY_MAX = 20;

            function safeGetItem(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    return null;
                }
            }
            function safeSetItem(key, val) {
                try {
                    localStorage.setItem(key, val);
                } catch (e) {}
            }
            function loadHistory() {
                const raw = safeGetItem(HISTORY_LS_KEY);
                if (!raw) return [];
                try {
                    const arr = JSON.parse(raw);
                    return Array.isArray(arr) ? arr : [];
                } catch (e) {
                    return [];
                }
            }
            function saveHistory(arr) {
                safeSetItem(HISTORY_LS_KEY, JSON.stringify(arr || []));
            }
            function addHistoryEntry(entry) {
                const list = loadHistory();
                list.unshift(entry);
                saveHistory(list.slice(0, HISTORY_MAX));
            }
            function fmtYmdHM(ts) {
                try {
                    const d = new Date(ts);
                    if (isNaN(d.getTime())) return "--/-- --:--";
                    const y = d.getFullYear();
                    const M = String(d.getMonth() + 1).padStart(2, "0");
                    const D = String(d.getDate()).padStart(2, "0");
                    const h = String(d.getHours()).padStart(2, "0");
                    const m = String(d.getMinutes()).padStart(2, "0");
                    return `${y}-${M}-${D} ${h}:${m}`;
                } catch (e) {
                    return "--/-- --:--";
                }
            }
            function renderHistorySheet() {
                const hist = loadHistory();
                historyList.innerHTML = "";
                if (!hist.length) {
                    const d = document.createElement("div");
                    d.className = "h-empty";
                    d.textContent = "この端末での注文履歴はありません。";
                    historyList.append(d);
                    return;
                }
                hist.forEach((h) => {
                    const box = document.createElement("div");
                    box.className = "h-item";

                    const head = document.createElement("div");
                    head.className = "h-head";
                    const seat = document.createElement("div");
                    seat.className = "h-seat";
                    seat.textContent = h.seat
                        ? `座席 ${h.seat}`
                        : "テイクアウト";
                    const meta = document.createElement("div");
                    meta.className = "h-meta";
                    meta.textContent = fmtYmdHM(h.ts);
                    head.append(seat, meta);

                    const body = document.createElement("div");
                    const blist = document.createElement("div");
                    blist.className = "brief-list";
                    buildSummary(blist, h.items || []);
                    body.append(blist);

                    box.append(head, body);
                    historyList.append(box);
                });
            }

            historyOpen.addEventListener("click", () => {
                renderHistorySheet();
                openSheet(historySheet, historyOpen, historyClose);
            });
            historyBackdrop.addEventListener("click", () =>
                closeSheet(historySheet),
            );
            historyClose.addEventListener("click", () =>
                closeSheet(historySheet),
            );
            historyClear.addEventListener("click", () => {
                if (!confirm("履歴をすべて削除しますか？")) return;
                saveHistory([]);
                renderHistorySheet();
                historyClose.focus();
            });

            /* 1回目：注文ボタン → 確認シート */
            submitBtn.addEventListener("click", () => {
                const items = collectOrderDetailed();
                const seat = seatEl.value.trim();

                if (!items.length) {
                    resultMsg.textContent = "数量を入力してください。";
                    resultMsg.className = "msg msg--error";
                    hideSeatError();
                    return;
                }
                if (!seat) {
                    // ここで座席エラーを座席UIの近くに赤字で表示
                    showSeatError();
                    return;
                }

                hideSeatError();
                confirmSeat.textContent = seat ? `座席 ${seat}` : "";
                buildSummary(confirmList);
                confirmOk.disabled = false;
                confirmOk.textContent = "注文を確定する";
                confirmOk.innerHTML = "注文を確定する"; // クリア
                openSheet(confirmSheet, submitBtn, confirmOk);
            });

            /* 確認シートの操作 */
            confirmBackdrop.addEventListener("click", () =>
                closeSheet(confirmSheet),
            );
            confirmBack.addEventListener("click", () =>
                closeSheet(confirmSheet),
            );

            function setLoading(btn, loading, labelWhenIdle) {
                if (loading) {
                    btn.disabled = true;
                    btn.innerHTML =
                        '<span class="spinner" aria-hidden="true"></span>送信中…';
                } else {
                    btn.disabled = false;
                    btn.innerHTML = labelWhenIdle || "OK";
                }
            }

            confirmOk.addEventListener("click", () => {
                const seat = seatEl.value.trim();
                const items = collectOrderDetailed();
                if (!items.length || !seat) return;

                setLoading(confirmOk, true, "注文を確定する");

                lastOrderSnapshot = {
                    seat,
                    items: items.map((x) => ({ ...x })),
                };

                fetch(`${API_BASE}?action=order`, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=UTF-8" },
                    body: JSON.stringify({
                        seat,
                        items: collectOrderPayload(),
                    }),
                })
                    .then((r) => r.json())
                    .then((res) => {
                        if (!res.ok) throw new Error(res.error || "failed");

                        // 履歴へ保存（lastOrderSnapshot を利用）
                        try {
                            const entry = {
                                ts: Date.now(),
                                seat: lastOrderSnapshot.seat || "",
                                items: (lastOrderSnapshot.items || []).map(
                                    (x) => ({
                                        name: x.name,
                                        quantity: x.quantity,
                                        price: x.price,
                                        total: x.total,
                                        itemId: x.itemId || null,
                                    }),
                                ),
                                groupId: res.groupId || null,
                            };
                            addHistoryEntry(entry);
                        } catch (e) {}

                        // 入力をリセット（座席は保持）
                        document
                            .querySelectorAll(".num")
                            .forEach((i) => (i.value = "0"));
                        document.querySelectorAll(".btn").forEach((b) => {
                            if (b.textContent === "−") b.disabled = true;
                        });
                        updateSummary();

                        // 完了シートへ
                        const trigger = confirmOk;
                        setLoading(confirmOk, false, "注文を確定する");
                        closeSheet(confirmSheet);

                        resultSeat.textContent = lastOrderSnapshot.seat
                            ? `座席 ${lastOrderSnapshot.seat}`
                            : "";
                        buildSummary(resultList, lastOrderSnapshot.items);

                        openSheet(resultSheet, trigger, resultClose);
                    })
                    .catch((err) => {
                        alert(
                            "送信に失敗しました：" +
                                ((err && err.message) || String(err)),
                        );
                        setLoading(confirmOk, false, "注文を確定する");
                    });
            });

            /* 完了シートの操作（右下＝閉じる／背景タップ） */
            function backToBuild() {
                lastOrderSnapshot = null;
                closeSheet(resultSheet);
                submitBtn.focus();
            }
            resultBackdrop.addEventListener("click", backToBuild);
            resultClose.addEventListener("click", backToBuild);

            /* 初期化：前回の座席を復元 */
            (function restoreLastSeat() {
                try {
                    const last = localStorage.getItem(LAST_SEAT_KEY);
                    if (last && /^([A-K])\-(\d{2})$/.test(last)) {
                        seatEl.value = last;
                        seatDisplay.textContent = `座席 ${last}`;
                        seatDisplay.classList.remove("muted");
                    }
                } catch (e) {}
            })();

            /* メニュー取得（重複fetchを排除） */
            renderMenuSkeleton();
            fetch(`${API_BASE}?action=menu`)
                .then((r) => r.json())
                .then((data) => renderMenu(data.menu || []))
                .catch(() => {
                    list.innerHTML =
                        '<div class="msg msg--error">メニュー読み込みに失敗しました。</div>';
                });

            // 画面読み込み時にサマリーを初期化
            updateSummary();
        </script>
    </body>
</html>
