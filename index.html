<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <title>モバイルオーダー（注文）</title>
        <style>
            :root {
                --bg: #f7f7fb;
                --card: #fff;
                --text: #121826;
                --muted: #6b7280;
                --border: #e6e7ec;
                --accent: #2563eb;
                --ring: 0 0 0 3px rgba(37, 99, 235, 0.25);
                --action-h: 80px;
                --action-gap: 24px;
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            html {
                font-size: 16px;
                scroll-padding-bottom: calc(
                    var(--action-h) + var(--action-gap) +
                        env(safe-area-inset-bottom)
                );
            }
            body {
                margin: 0;
                background: var(--bg);
                color: var(--text);
                font-family:
                    system-ui,
                    -apple-system,
                    "Segoe UI",
                    Roboto,
                    "Helvetica Neue",
                    Arial,
                    sans-serif;
                -webkit-text-size-adjust: 100%;
                -webkit-tap-highlight-color: transparent;
                padding: 16px;
                line-height: 1.5;
                font-feature-settings:
                    "tnum" 1,
                    "cv01" 1;
            }
            .container {
                width: 100%;
                max-width: 640px;
                margin: 0 auto;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            h1 {
                margin: 0;
                font-size: clamp(18px, 4.5vw, 22px);
                font-weight: 800;
                letter-spacing: 0.01em;
            }
            .sub {
                margin-top: 4px;
                color: var(--muted);
                font-size: 0.92rem;
            }

            /* 商品リスト */
            .list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .item {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 8px 12px;
                align-items: center;
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 12px;
            }
            .info {
                min-width: 0;
            }
            .name {
                font-weight: 700;
                line-height: 1.3;
                word-break: break-word;
                overflow-wrap: anywhere;
            }
            .meta {
                margin-top: 6px;
                color: var(--muted);
                font-size: 0.95rem;
            }
            .price {
                font-weight: 800;
            }

            /* ステッパー */
            .stepper {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .btn {
                appearance: none;
                border: 1px solid var(--border);
                background: #fff;
                color: var(--text);
                width: 44px;
                height: 44px;
                border-radius: 999px;
                font-size: 20px;
                line-height: 1;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.05s ease;
            }
            .btn:active {
                transform: translateY(1px);
            }
            .btn:focus-visible {
                outline: none;
                box-shadow: var(--ring);
            }
            .btn[disabled] {
                opacity: 0.45;
                cursor: not-allowed;
            }

            /* 数値入力（スピナー非表示） */
            .num {
                width: 76px;
                min-height: 44px;
                text-align: center;
                font-size: 1rem;
                padding: 10px 8px;
                border: 1px solid var(--border);
                border-radius: 10px;
                background: #fff;
                color: var(--text);
                outline: none;
                scroll-margin-bottom: calc(var(--action-h) + var(--action-gap));
            }
            .num:focus-visible {
                box-shadow: var(--ring);
            }
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type="number"] {
                -moz-appearance: textfield;
            }

            /* 座席番号（2列ピッカー対応） */
            .field {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .field label {
                color: var(--muted);
            }
            .input {
                width: 100%;
                min-height: 44px;
                font-size: 1rem;
                padding: 12px 14px;
                background: #fff;
                color: var(--text);
                border: 1px solid var(--border);
                border-radius: 10px;
                outline: none;
                text-align: left;
            }
            .input:focus-visible {
                box-shadow: var(--ring);
            }
            .muted {
                color: var(--muted);
            }

            /* メッセージ */
            .msg {
                font-size: 0.95rem;
                color: var(--muted);
            }
            .msg--error {
                color: #dc2626;
            }
            .msg--ok {
                color: #047857;
            }

            /* 固定アクションバー */
            .action {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: max(16px, env(safe-area-inset-bottom));
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 10px 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
                z-index: 50;
            }
            .summary {
                font-weight: 800;
                white-space: nowrap;
            }
            .summary [data-amount] {
                font-variant-numeric: tabular-nums;
            }
            .primary {
                appearance: none;
                border: none;
                background: var(--accent);
                color: #fff;
                padding: 12px 18px;
                min-height: 44px;
                border-radius: 999px;
                font-size: 1rem;
                cursor: pointer;
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
            }
            .primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                box-shadow: none;
            }

            /* 下スペーサー（固定バーに隠れないよう確保） */
            .bottom-spacer {
                height: calc(
                    var(--action-h) + var(--action-gap) +
                        env(safe-area-inset-bottom)
                );
            }

            /* モーダル（2列ピッカー） */
            .modal[hidden] {
                display: none;
            }
            .modal {
                position: fixed;
                inset: 0;
                z-index: 100;
            }
            .modal__backdrop {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.35);
            }
            .modal__panel {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 16px;
                width: min(560px, 92vw);
                max-width: 560px;
                box-shadow: 0 24px 48px rgba(0, 0, 0, 0.18);
                display: grid;
                grid-template-rows: auto 1fr auto;
                max-height: 85vh;
            }
            .modal__header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                padding: 12px 14px;
                border-bottom: 1px solid var(--border);
            }
            .modal__title {
                font-weight: 800;
            }
            .modal__close {
                appearance: none;
                border: 1px solid var(--border);
                background: #fff;
                color: var(--text);
                width: 36px;
                height: 36px;
                border-radius: 10px;
                cursor: pointer;
                font-size: 18px;
                line-height: 1;
            }
            .picker {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                padding: 12px 14px;
            }
            .picker__col {
                display: grid;
                grid-template-rows: auto 1fr;
                gap: 8px;
                min-width: 0;
            }
            .picker__label {
                color: var(--muted);
                font-size: 0.92rem;
            }
            .picker__select {
                width: 100%;
                min-height: 220px; /* ホイールっぽく見えるように複数行表示 */
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 8px;
                font-size: 1.05rem;
                background: #fff;
                outline: none;
            }
            .picker__select:focus-visible {
                box-shadow: var(--ring);
            }
            .modal__footer {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 14px;
                border-top: 1px solid var(--border);
            }
            .btn--ghost {
                appearance: none;
                border: 1px solid var(--border);
                background: #fff;
                color: var(--text);
                padding: 10px 14px;
                border-radius: 10px;
                cursor: pointer;
            }
            .spacer {
                flex: 1 1 auto;
            }
            .no-scroll {
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div>
                    <h1>ご注文</h1>
                    <div class="sub">数量を入力して「注文する」をタップ</div>
                </div>
            </header>

            <div id="list" class="list" aria-live="polite">読み込み中…</div>

            <div class="field">
                <label for="seatOpen">座席番号</label>
                <button
                    id="seatOpen"
                    class="input"
                    type="button"
                    aria-haspopup="dialog"
                    aria-controls="seatModal"
                >
                    <span id="seatDisplay" class="muted">座席を選択</span>
                </button>
                <input id="seat" type="hidden" />
            </div>

            <div id="result" class="msg" aria-live="polite"></div>

            <div class="bottom-spacer" aria-hidden="true"></div>
        </div>

        <!-- 2列ピッカーモーダル -->
        <div
            id="seatModal"
            class="modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="seatTitle"
            hidden
        >
            <div class="modal__backdrop" id="seatBackdrop"></div>
            <div class="modal__panel" role="document">
                <div class="modal__header">
                    <div class="modal__title" id="seatTitle">座席を選択</div>
                    <button
                        class="modal__close"
                        id="seatClose"
                        aria-label="閉じる"
                    >
                        ×
                    </button>
                </div>
                <div class="picker">
                    <div class="picker__col">
                        <label class="picker__label" for="areaSelect"
                            >エリア</label
                        >
                        <select
                            id="areaSelect"
                            class="picker__select"
                            size="7"
                        ></select>
                    </div>
                    <div class="picker__col">
                        <label class="picker__label" for="numberSelect"
                            >番号</label
                        >
                        <select
                            id="numberSelect"
                            class="picker__select"
                            size="7"
                        ></select>
                    </div>
                </div>
                <div class="modal__footer">
                    <button id="seatClear" class="btn--ghost" type="button">
                        クリア
                    </button>
                    <div class="spacer"></div>
                    <button id="seatCancel" class="btn--ghost" type="button">
                        キャンセル
                    </button>
                    <button id="seatOk" class="primary" type="button" disabled>
                        決定
                    </button>
                </div>
            </div>
        </div>

        <div
            class="action"
            id="actionBar"
            role="region"
            aria-label="注文の合計"
        >
            <div class="summary" aria-live="polite">
                <span id="count">0</span> 点 / 合計
                <span id="total" data-amount>¥0</span>
            </div>
            <button id="submitBtn" class="primary" disabled>注文する</button>
        </div>

        <script>
            const API_BASE =
                "https://script.google.com/macros/s/AKfycbx13V768FI1C79iewAv8q5j5dp-EB1gOzh0UurwnGnEoEiud8cpzSBmAeALs8HW8R893w/exec"; // ←置き換え
            const list = document.getElementById("list");
            const seatEl = document.getElementById("seat");
            const seatOpen = document.getElementById("seatOpen");
            const seatDisplay = document.getElementById("seatDisplay");
            const seatModal = document.getElementById("seatModal");
            const seatBackdrop = document.getElementById("seatBackdrop");
            const seatClose = document.getElementById("seatClose");
            const seatCancel = document.getElementById("seatCancel");
            const seatOk = document.getElementById("seatOk");
            const seatClear = document.getElementById("seatClear");
            const areaSelect = document.getElementById("areaSelect");
            const numberSelect = document.getElementById("numberSelect");

            const submitBtn = document.getElementById("submitBtn");
            const result = document.getElementById("result");
            const actionBar = document.getElementById("actionBar");
            const countEl = document.getElementById("count");
            const totalEl = document.getElementById("total");

            const AREAS = [
                "A",
                "B",
                "C",
                "D",
                "E",
                "F",
                "G",
                "H",
                "I",
                "J",
                "K",
            ];
            const NUMS = Array.from({ length: 21 }, (_, i) => String(i + 1));

            const yen = (n) => "¥" + Number(n || 0).toLocaleString("ja-JP");

            // 固定バーの実寸を検知して --action-h を更新（隠れ防止）
            new ResizeObserver(() => {
                const h = actionBar.offsetHeight || 80;
                document.documentElement.style.setProperty(
                    "--action-h",
                    h + "px",
                );
            }).observe(actionBar);

            function renderMenu(items) {
                list.innerHTML = "";
                if (!items || !items.length) {
                    const div = document.createElement("div");
                    div.className = "msg";
                    div.textContent = "現在ご注文いただける商品がありません。";
                    list.append(div);
                    submitBtn.disabled = true;
                    return;
                }
                for (const it of items) {
                    const row = document.createElement("div");
                    row.className = "item";
                    row.dataset.itemId = it.id;
                    row.dataset.price = it.price;

                    const info = document.createElement("div");
                    info.className = "info";
                    info.innerHTML = `<div class="name">${it.name}</div>
                      <div class="meta"><span class="price">${yen(it.price)}</span>（税込）</div>`;

                    const stepper = document.createElement("div");
                    stepper.className = "stepper";

                    const minus = document.createElement("button");
                    minus.type = "button";
                    minus.className = "btn";
                    minus.textContent = "−";
                    minus.setAttribute("aria-label", it.name + " を1つ減らす");
                    minus.disabled = true;

                    const input = document.createElement("input");
                    input.className = "num";
                    input.type = "number";
                    input.min = "0";
                    input.step = "1";
                    input.value = "0";
                    input.inputMode = "numeric";
                    input.setAttribute("aria-label", it.name + " の数量");

                    const plus = document.createElement("button");
                    plus.type = "button";
                    plus.className = "btn";
                    plus.textContent = "+";
                    plus.setAttribute("aria-label", it.name + " を1つ増やす");

                    const setQty = (v) => {
                        v = Math.max(0, parseInt(v || "0", 10) || 0);
                        input.value = String(v);
                        minus.disabled = v <= 0;
                        updateSummary();
                    };
                    minus.addEventListener("click", () =>
                        setQty(parseInt(input.value || "0", 10) - 1),
                    );
                    plus.addEventListener("click", () =>
                        setQty(parseInt(input.value || "0", 10) + 1),
                    );
                    input.addEventListener("input", () => setQty(input.value));

                    stepper.append(minus, input, plus);
                    row.append(info, stepper);
                    list.append(row);
                }
                updateSummary();
            }

            function collectOrder() {
                const items = [];
                list.querySelectorAll(".item").forEach((r) => {
                    const qty = parseInt(
                        r.querySelector(".num").value || "0",
                        10,
                    );
                    if (qty > 0)
                        items.push({
                            itemId: r.dataset.itemId,
                            quantity: qty,
                            price: Number(r.dataset.price),
                        });
                });
                return items;
            }

            function updateSummary() {
                const items = collectOrder();
                const count = items.reduce((s, x) => s + x.quantity, 0);
                const total = items.reduce(
                    (s, x) => s + x.quantity * x.price,
                    0,
                );
                countEl.textContent = count;
                totalEl.textContent = yen(total);
                submitBtn.disabled = count === 0 || !seatEl.value.trim();
            }
            seatEl.addEventListener("input", updateSummary);

            // メニュー取得
            fetch(`${API_BASE}?action=menu`)
                .then((r) => r.json())
                .then((data) => renderMenu(data.menu || []))
                .catch(() => {
                    list.innerHTML =
                        '<div class="msg msg--error">メニュー読み込みに失敗しました。</div>';
                });

            // 座席ピッカー初期化
            function populateSeatOptions() {
                if (!areaSelect.options.length) {
                    AREAS.forEach((a) => {
                        const opt = document.createElement("option");
                        opt.value = a;
                        opt.textContent = a;
                        areaSelect.append(opt);
                    });
                }
                if (!numberSelect.options.length) {
                    NUMS.forEach((n) => {
                        const opt = document.createElement("option");
                        opt.value = n;
                        opt.textContent = n;
                        numberSelect.append(opt);
                    });
                }
            }

            function openSeatModal() {
                populateSeatOptions();
                // 既存値を分解
                const v = seatEl.value.trim();
                let curA = "",
                    curN = "";
                if (v && /^[A-K]-([1-9]|1\d|2[01])$/.test(v)) {
                    const [a, n] = v.split("-");
                    curA = a;
                    curN = n;
                }
                areaSelect.value = curA || "";
                numberSelect.value = curN || "";
                seatOk.disabled = !(areaSelect.value && numberSelect.value);

                seatModal.hidden = false;
                document.body.classList.add("no-scroll");
                // フォーカス
                (areaSelect.value ? numberSelect : areaSelect).focus();
            }
            function closeSeatModal() {
                seatModal.hidden = true;
                document.body.classList.remove("no-scroll");
                seatOpen.focus();
            }

            seatOpen.addEventListener("click", openSeatModal);
            seatBackdrop.addEventListener("click", closeSeatModal);
            seatClose.addEventListener("click", closeSeatModal);
            seatCancel.addEventListener("click", closeSeatModal);
            window.addEventListener("keydown", (e) => {
                if (!seatModal.hidden && e.key === "Escape") {
                    e.preventDefault();
                    closeSeatModal();
                }
            });

            areaSelect.addEventListener("change", () => {
                seatOk.disabled = !(areaSelect.value && numberSelect.value);
            });
            numberSelect.addEventListener("change", () => {
                seatOk.disabled = !(areaSelect.value && numberSelect.value);
            });

            seatOk.addEventListener("click", () => {
                if (!(areaSelect.value && numberSelect.value)) return;
                const seatStr = `${areaSelect.value}-${numberSelect.value}`;
                seatEl.value = seatStr;
                seatDisplay.textContent = `座席 ${seatStr}`;
                seatDisplay.classList.remove("muted");
                updateSummary();
                closeSeatModal();
            });

            seatClear.addEventListener("click", () => {
                areaSelect.value = "";
                numberSelect.value = "";
                seatEl.value = "";
                seatDisplay.textContent = "座席を選択";
                seatDisplay.classList.add("muted");
                seatOk.disabled = true;
                updateSummary();
            });

            // 注文送信（プリフライト回避のため text/plain）
            submitBtn.addEventListener("click", () => {
                const items = collectOrder();
                const seat = seatEl.value.trim();
                if (!items.length) {
                    result.textContent = "数量を入力してください。";
                    result.className = "msg msg--error";
                    return;
                }
                if (!seat) {
                    result.textContent = "座席番号を選択してください。";
                    result.className = "msg msg--error";
                    seatOpen.focus();
                    seatOpen.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                    });
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = "送信中…";
                result.textContent = "";
                result.className = "msg";
                fetch(`${API_BASE}?action=order`, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=UTF-8" },
                    body: JSON.stringify({ seat, items }),
                })
                    .then((r) => r.json())
                    .then((res) => {
                        if (!res.ok) throw new Error(res.error || "failed");
                        result.textContent = `注文を受け付けました。注文ID: ${res.groupId}（${res.totalQuantity}点 / 合計 ${yen(res.totalAmount)}）`;
                        result.className = "msg msg--ok";
                        document
                            .querySelectorAll(".num")
                            .forEach((i) => (i.value = "0"));
                        document.querySelectorAll(".btn").forEach((b) => {
                            if (b.textContent === "−") b.disabled = true;
                        });
                        // 座席は残す（連続注文向け）。リセットしたい場合は以下2行を有効化。
                        // seatEl.value = "";
                        // seatDisplay.textContent = "座席を選択"; seatDisplay.classList.add("muted");
                        updateSummary();
                        window.scrollTo({ top: 0, behavior: "smooth" });
                    })
                    .catch((err) => {
                        result.textContent =
                            "送信に失敗しました：" +
                            ((err && err.message) || String(err));
                        result.className = "msg msg--error";
                    })
                    .finally(() => {
                        submitBtn.textContent = "注文する";
                        submitBtn.disabled = false;
                    });
            });
        </script>
    </body>
</html>
