<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <title>モバイルオーダー（注文）</title>
        <style>
            :root {
                --bg: #f7f7fb;
                --card: #fff;
                --text: #121826;
                --muted: #6b7280;
                --border: #e6e7ec;
                --accent: #2563eb;
                --ring: 0 0 0 3px rgba(37, 99, 235, 0.25);
                --action-h: 80px;
                --action-gap: 24px;

                /* ピッカー用 */
                --row: 44px;
                --wheel-h: 220px;
                --sheet-radius: 16px;
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            html {
                font-size: 16px;
                scroll-padding-bottom: calc(
                    var(--action-h) + var(--action-gap) +
                        env(safe-area-inset-bottom)
                );
            }
            body {
                margin: 0;
                background: var(--bg);
                color: var(--text);
                font-family:
                    system-ui,
                    -apple-system,
                    "Segoe UI",
                    Roboto,
                    "Helvetica Neue",
                    Arial,
                    sans-serif;
                -webkit-text-size-adjust: 100%;
                -webkit-tap-highlight-color: transparent;
                padding: 16px;
                line-height: 1.5;
                font-feature-settings:
                    "tnum" 1,
                    "cv01" 1;
            }
            .container {
                width: 100%;
                max-width: 640px;
                margin: 0 auto;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            h1 {
                margin: 0;
                font-size: clamp(18px, 4.5vw, 22px);
                font-weight: 800;
                letter-spacing: 0.01em;
            }
            .sub {
                margin-top: 4px;
                color: var(--muted);
                font-size: 0.92rem;
            }

            /* お知らせ（全品売切れ） */
            .notice {
                background: #fff7ed;
                color: #9a3412;
                border: 1px solid #fed7aa;
                border-radius: 12px;
                padding: 10px 12px;
            }
            .notice[hidden] {
                display: none;
            }

            /* 商品リスト */
            .list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .item {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 8px 12px;
                align-items: center;
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 12px;
            }
            .item--soldout {
                opacity: 0.85;
            }
            .info {
                min-width: 0;
            }
            .name {
                font-weight: 700;
                line-height: 1.3;
                word-break: break-word;
                overflow-wrap: anywhere;
            }
            .meta {
                margin-top: 6px;
                color: var(--muted);
                font-size: 0.95rem;
            }
            .price {
                font-weight: 800;
            }
            .sold {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 12px;
                border-radius: 999px;
                background: #fee2e2;
                color: #991b1b;
                border: 1px solid #fecaca;
                font-weight: 800;
                white-space: nowrap;
            }

            /* ステッパー */
            .stepper {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .btn {
                appearance: none;
                border: 1px solid var(--border);
                background: #fff;
                color: var(--text);
                width: 44px;
                height: 44px;
                border-radius: 999px;
                font-size: 20px;
                line-height: 1;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.05s ease;
            }
            .btn:active {
                transform: translateY(1px);
            }
            .btn:focus-visible {
                outline: none;
                box-shadow: var(--ring);
            }
            .btn[disabled] {
                opacity: 0.45;
                cursor: not-allowed;
            }
            .num {
                width: 76px;
                min-height: 44px;
                text-align: center;
                font-size: 1rem;
                padding: 10px 8px;
                border: 1px solid var(--border);
                border-radius: 10px;
                background: #fff;
                color: var(--text);
                outline: none;
                scroll-margin-bottom: calc(var(--action-h) + var(--action-gap));
            }
            .num:focus-visible {
                box-shadow: var(--ring);
            }
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type="number"] {
                -moz-appearance: textfield;
            }

            /* 座席番号（インライン表示＋ローラーピッカー起動） */
            .field {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .field label {
                color: var(--muted);
            }
            .input-like {
                width: 100%;
                min-height: 44px;
                font-size: 1rem;
                padding: 12px 14px;
                background: #fff;
                color: var(--text);
                border: 1px solid var(--border);
                border-radius: 10px;
                outline: none;
                text-align: left;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                cursor: pointer;
            }
            .input-like:focus-visible {
                box-shadow: var(--ring);
            }
            .muted {
                color: var(--muted);
            }

            /* 確認・完了パネル（カード内の共通部品） */
            .p-body {
                display: grid;
                gap: 8px;
            }
            .brief-list {
                display: grid;
                gap: 6px;
            }
            .row-brief {
                display: grid;
                grid-template-columns: 1fr auto auto;
                gap: 6px 12px;
                align-items: baseline;
                border-bottom: 1px dashed #e5e7eb;
                padding: 6px 0;
            }
            .row-brief:last-child {
                border-bottom: none;
            }
            .brief-name {
                font-weight: 700;
            }
            .brief-qty {
                color: var(--muted);
            }
            .brief-price {
                color: var(--muted);
            }
            .sumline {
                text-align: right;
                font-weight: 800;
                margin-top: 2px;
            }
            .hint {
                color: var(--muted);
                font-size: 0.95rem;
            }

            /* メッセージ */
            .msg {
                font-size: 0.95rem;
                color: var(--muted);
            }
            .msg--error {
                color: #dc2626;
            }
            .msg--ok {
                color: #047857;
            }

            /* 固定アクションバー（共通） */
            .action {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: max(16px, env(safe-area-inset-bottom));
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 10px 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
                z-index: 50;
            }
            .action[hidden] {
                display: none;
            }
            .summary {
                font-weight: 800;
                white-space: nowrap;
            }
            .summary [data-amount] {
                font-variant-numeric: tabular-nums;
            }
            .primary {
                appearance: none;
                border: none;
                background: var(--accent);
                color: #fff;
                padding: 12px 18px;
                min-height: 44px;
                border-radius: 999px;
                font-size: 1rem;
                cursor: pointer;
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
            }
            .primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                box-shadow: none;
            }

            /* 下スペーサー（固定バー分の余白） */
            .bottom-spacer {
                height: calc(
                    var(--action-h) + var(--action-gap) +
                        env(safe-area-inset-bottom)
                );
            }

            /* ボトムシート（iOSピッカー風ローラー＋確認/完了） */
            .sheet {
                position: fixed;
                inset: 0;
                z-index: 100;
                pointer-events: none;
            }
            .sheet[hidden] {
                display: none;
            }
            .sheet__backdrop {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.35);
                opacity: 0;
                transition: opacity 160ms ease;
            }
            .sheet__panel {
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                transform: translateY(100%);
                background: var(--card);
                border-top-left-radius: var(--sheet-radius);
                border-top-right-radius: var(--sheet-radius);
                border: 1px solid var(--border);
                border-bottom: none;
                box-shadow: 0 -16px 48px rgba(0, 0, 0, 0.18);
                transition: transform 200ms ease;
                display: grid;
                grid-template-rows: auto 1fr auto;
                gap: 0;
                pointer-events: auto;
                max-height: 85vh;
            }
            .sheet--open .sheet__backdrop {
                opacity: 1;
            }
            .sheet--open .sheet__panel {
                transform: translateY(0%);
            }
            .sheet__header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 12px;
                border-bottom: 1px solid var(--border);
            }
            .sheet__title {
                font-weight: 800;
            }
            .sheet__content {
                overflow: auto;
                padding: 12px 14px;
                display: grid;
                gap: 10px;
            }
            .sheet__footer {
                padding: 10px 12px;
                border-top: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 8px;
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
            .btn--ghost {
                appearance: none;
                border: 1px solid var(--border);
                background: #fff;
                color: var(--text);
                padding: 10px 14px;
                border-radius: 999px;
                cursor: pointer;
            }

            /* シート内の補助 */
            .seat-note {
                color: var(--muted);
            }

            /* ピッカー固有（座席） */
            .sheet__wheels {
                position: relative;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                padding: 12px 14px;
            }
            .wheel {
                position: relative;
                height: var(--wheel-h);
                overflow: hidden;
                border: 1px solid var(--border);
                border-radius: 12px;
                background: #fff;
            }
            .wheel__list {
                height: 100%;
                overflow: auto;
                scroll-snap-type: y mandatory;
                -webkit-overflow-scrolling: touch;
                padding-top: calc((var(--wheel-h) - var(--row)) / 2);
                padding-bottom: calc((var(--wheel-h) - var(--row)) / 2);
                margin: 0;
            }
            .wheel__item {
                height: var(--row);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.15rem;
                scroll-snap-align: center;
                user-select: none;
            }
            .wheel__item.selected {
                font-weight: 800;
                color: var(--accent);
            }
            .indicator {
                position: absolute;
                left: 14px;
                right: 14px;
                top: 50%;
                transform: translateY(-50%);
                height: var(--row);
                pointer-events: none;
                border-top: 1px solid #e5e7eb;
                border-bottom: 1px solid #e5e7eb;
                border-radius: 6px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div>
                    <h1>ご注文</h1>
                    <div class="sub">数量を入力して「注文する」をタップ</div>
                </div>
            </header>

            <div id="notice" class="notice" hidden aria-live="polite"></div>

            <!-- 通常のメニュー一覧 -->
            <div id="list" class="list" aria-live="polite">読み込み中…</div>

            <!-- 座席 -->
            <div id="seatField" class="field">
                <label for="seatOpen">座席番号</label>
                <button
                    id="seatOpen"
                    class="input-like"
                    type="button"
                    aria-haspopup="dialog"
                    aria-controls="seatSheet"
                >
                    <span id="seatDisplay" class="muted">座席を選択</span>
                </button>
                <input id="seat" type="hidden" />
            </div>

            <div id="result" class="msg" aria-live="polite"></div>

            <div class="bottom-spacer" aria-hidden="true"></div>
        </div>

        <!-- 座席ピッカー（既存） -->
        <div
            id="seatSheet"
            class="sheet"
            role="dialog"
            aria-modal="true"
            aria-labelledby="seatTitle"
            hidden
        >
            <div class="sheet__backdrop" id="sheetBackdrop"></div>
            <div class="sheet__panel" role="document">
                <div class="sheet__header">
                    <div class="sheet__title" id="seatTitle">座席を選択</div>
                    <div class="sheet__actions">
                        <button id="seatClear" class="btn--ghost" type="button">
                            クリア
                        </button>
                        <button
                            id="seatDone"
                            class="primary"
                            type="button"
                            disabled
                        >
                            完了
                        </button>
                    </div>
                </div>
                <div class="sheet__wheels">
                    <div class="wheel">
                        <div class="wheel__list" id="wheelArea"></div>
                    </div>
                    <div class="wheel">
                        <div class="wheel__list" id="wheelNum"></div>
                    </div>
                    <div class="indicator" aria-hidden="true"></div>
                </div>
                <div class="sheet__footer">
                    <button id="seatCancel" class="btn--ghost" type="button">
                        閉じる
                    </button>
                </div>
            </div>
        </div>

        <!-- 注文内容の確認（新規・下からポップアップ） -->
        <div
            id="confirmSheet"
            class="sheet"
            role="dialog"
            aria-modal="true"
            aria-labelledby="confirmTitle"
            hidden
        >
            <div class="sheet__backdrop" id="confirmBackdrop"></div>
            <div class="sheet__panel" role="document">
                <div class="sheet__header">
                    <div class="sheet__title" id="confirmTitle">
                        注文内容の確認
                    </div>
                    <div class="seat-note" id="confirmSeat"></div>
                </div>
                <div class="sheet__content">
                    <div class="p-body">
                        <div id="confirmList" class="brief-list"></div>
                    </div>
                </div>
                <div class="sheet__footer">
                    <button id="confirmBack" class="btn--ghost" type="button">
                        戻る
                    </button>
                    <button id="confirmOk" class="primary" type="button">
                        注文を確定する
                    </button>
                </div>
            </div>
        </div>

        <!-- 注文完了（新規・下からポップアップ） -->
        <div
            id="resultSheet"
            class="sheet"
            role="dialog"
            aria-modal="true"
            aria-labelledby="resultTitle"
            hidden
        >
            <div class="sheet__backdrop" id="resultBackdrop"></div>
            <div class="sheet__panel" role="document">
                <div class="sheet__header">
                    <div class="sheet__title" id="resultTitle">
                        ご注文ありがとうございました
                    </div>
                    <div class="seat-note" id="resultSeat"></div>
                </div>
                <div class="sheet__content">
                    <div class="hint">
                        注文を準備しております。まもなくスタッフがお届けしますので、代金をご用意の上、少々お待ちください。
                    </div>
                    <div class="p-body" style="margin-top: 6px">
                        <div id="resultList" class="brief-list"></div>
                    </div>
                </div>
                <div class="sheet__footer">
                    <button id="resultBack" class="primary" type="button">
                        戻る
                    </button>
                </div>
            </div>
        </div>

        <!-- 入力用 下部バー -->
        <div
            class="action"
            id="actionBar"
            role="region"
            aria-label="注文の合計"
        >
            <div class="summary" aria-live="polite">
                <span id="count">0</span> 点 / 合計
                <span id="total" data-amount>¥0</span>
            </div>
            <button id="submitBtn" class="primary" disabled>注文する</button>
        </div>

        <script>
            const API_BASE =
                "https://script.google.com/macros/s/AKfycbx13V768FI1C79iewAv8q5j5dp-EB1gOzh0UurwnGnEoEiud8cpzSBmAeALs8HW8R893w/exec"; // ←置き換え

            const list = document.getElementById("list");
            const notice = document.getElementById("notice");

            const seatField = document.getElementById("seatField");
            const seatEl = document.getElementById("seat");
            const seatOpen = document.getElementById("seatOpen");
            const seatDisplay = document.getElementById("seatDisplay");

            // 座席シート
            const seatSheet = document.getElementById("seatSheet");
            const seatBackdrop = document.getElementById("sheetBackdrop");
            const seatDone = document.getElementById("seatDone");
            const seatCancel = document.getElementById("seatCancel");
            const seatClear = document.getElementById("seatClear");
            const wheelArea = document.getElementById("wheelArea");
            const wheelNum = document.getElementById("wheelNum");

            // 確認シート
            const confirmSheet = document.getElementById("confirmSheet");
            const confirmBackdrop = document.getElementById("confirmBackdrop");
            const confirmSeat = document.getElementById("confirmSeat");
            const confirmList = document.getElementById("confirmList");
            const confirmBack = document.getElementById("confirmBack");
            const confirmOk = document.getElementById("confirmOk");

            // 完了シート
            const resultSheet = document.getElementById("resultSheet");
            const resultBackdrop = document.getElementById("resultBackdrop");
            const resultSeat = document.getElementById("resultSeat");
            const resultList = document.getElementById("resultList");
            const resultBack = document.getElementById("resultBack");

            const actionBar = document.getElementById("actionBar");
            const submitBtn = document.getElementById("submitBtn");
            const result = document.getElementById("result");
            const countEl = document.getElementById("count");
            const totalEl = document.getElementById("total");

            const pad2 = (n) => String(n).padStart(2, "0");
            const AREAS = [
                "A",
                "B",
                "C",
                "D",
                "E",
                "F",
                "G",
                "H",
                "I",
                "J",
                "K",
            ];
            const NUMS = Array.from({ length: 21 }, (_, i) => pad2(i + 1));

            const ROW_H = 44;
            let tmpArea = null;
            let tmpNum = null;
            let scrollTimers = new Map();
            let lastOrderSnapshot = null;

            const yen = (n) => "¥" + Number(n || 0).toLocaleString("ja-JP");

            // 固定バー高さをCSS変数に反映
            new ResizeObserver(() => {
                const h = actionBar.offsetHeight || 80;
                document.documentElement.style.setProperty(
                    "--action-h",
                    h + "px",
                );
            }).observe(actionBar);

            function renderMenu(items) {
                list.innerHTML = "";
                notice.hidden = true;
                notice.textContent = "";

                if (!items || !items.length) {
                    const div = document.createElement("div");
                    div.className = "msg";
                    div.textContent = "現在ご注文いただける商品がありません。";
                    list.append(div);
                    submitBtn.disabled = true;
                    return;
                }

                const anyActive = items.some((it) => !!it.active);
                if (!anyActive) {
                    notice.hidden = false;
                    notice.textContent =
                        "モバイルオーダーは試合開始後に受け付けます。";
                }

                for (const it of items) {
                    const row = document.createElement("div");
                    row.className =
                        "item" + (it.active ? "" : " item--soldout");
                    row.dataset.itemId = it.id;
                    row.dataset.price = it.price;
                    row.dataset.active = String(!!it.active);

                    const info = document.createElement("div");
                    info.className = "info";
                    info.innerHTML = `<div class="name">${it.name}</div>
            <div class="meta"><span class="price">${yen(it.price)}</span>（税込）</div>`;

                    const right = document.createElement("div");

                    if (it.active) {
                        const stepper = document.createElement("div");
                        stepper.className = "stepper";

                        const minus = document.createElement("button");
                        minus.type = "button";
                        minus.className = "btn";
                        minus.textContent = "−";
                        minus.setAttribute(
                            "aria-label",
                            it.name + " を1つ減らす",
                        );
                        minus.disabled = true;

                        const input = document.createElement("input");
                        input.className = "num";
                        input.type = "number";
                        input.min = "0";
                        input.step = "1";
                        input.value = "0";
                        input.inputMode = "numeric";
                        input.setAttribute("aria-label", it.name + " の数量");

                        const plus = document.createElement("button");
                        plus.type = "button";
                        plus.className = "btn";
                        plus.textContent = "+";
                        plus.setAttribute(
                            "aria-label",
                            it.name + " を1つ増やす",
                        );

                        const setQty = (v) => {
                            v = Math.max(0, parseInt(v || "0", 10) || 0);
                            input.value = String(v);
                            minus.disabled = v <= 0;
                            updateSummary();
                        };
                        minus.addEventListener("click", () =>
                            setQty(parseInt(input.value || "0", 10) - 1),
                        );
                        plus.addEventListener("click", () =>
                            setQty(parseInt(input.value || "0", 10) + 1),
                        );
                        input.addEventListener("input", () =>
                            setQty(input.value),
                        );

                        stepper.append(minus, input, plus);
                        right.append(stepper);
                    } else {
                        const sold = document.createElement("span");
                        sold.className = "sold";
                        sold.textContent = "売切れ";
                        right.append(sold);
                    }

                    row.append(info, right);
                    list.append(row);
                }
                updateSummary();
            }

            function collectOrderDetailed() {
                const items = [];
                list.querySelectorAll(".item").forEach((r) => {
                    const active = r.dataset.active === "true";
                    if (!active) return;
                    const qty = parseInt(
                        r.querySelector(".num").value || "0",
                        10,
                    );
                    if (qty > 0) {
                        const name =
                            r.querySelector(".name")?.textContent?.trim() || "";
                        const price = Number(r.dataset.price);
                        items.push({
                            itemId: r.dataset.itemId,
                            name,
                            quantity: qty,
                            price,
                            total: price * qty,
                        });
                    }
                });
                return items;
            }
            function collectOrderPayload() {
                return collectOrderDetailed().map((x) => ({
                    itemId: x.itemId,
                    quantity: x.quantity,
                }));
            }

            function updateSummary() {
                const items = collectOrderDetailed();
                const count = items.reduce((s, x) => s + x.quantity, 0);
                const total = items.reduce((s, x) => s + x.total, 0);
                countEl.textContent = count;
                totalEl.textContent = yen(total);
                submitBtn.disabled = count === 0 || !seatEl.value.trim();
            }

            // メニュー取得
            fetch(`${API_BASE}?action=menu`)
                .then((r) => r.json())
                .then((data) => renderMenu(data.menu || []))
                .catch(() => {
                    list.innerHTML =
                        '<div class="msg msg--error">メニュー読み込みに失敗しました。</div>';
                });

            /* 汎用シート制御 */
            function openSheet(sheet) {
                sheet.hidden = false;
                requestAnimationFrame(() => {
                    sheet.classList.add("sheet--open");
                    document.body.classList.add("no-scroll");
                });
            }
            function closeSheet(sheet) {
                sheet.classList.remove("sheet--open");
                document.body.classList.remove("no-scroll");
                setTimeout(() => {
                    sheet.hidden = true;
                }, 200);
            }

            /* 座席ピッカー */
            function makeWheelItems(el, values) {
                el.innerHTML = "";
                values.forEach((v) => {
                    const d = document.createElement("div");
                    d.className = "wheel__item";
                    d.dataset.value = v;
                    d.textContent = v;
                    el.appendChild(d);
                });
            }
            function setSelectedClass(el, index) {
                const items = el.querySelectorAll(".wheel__item");
                items.forEach((it, i) => {
                    if (i === index) it.classList.add("selected");
                    else it.classList.remove("selected");
                });
            }
            function nearestIndex(el) {
                const t = el.scrollTop;
                return Math.max(
                    0,
                    Math.min(el.children.length - 1, Math.round(t / 44)),
                );
            }
            function scrollToIndex(el, index, behavior = "smooth") {
                el.scrollTo({ top: index * 44, behavior });
            }
            function handleScroll(el, onChange) {
                if (scrollTimers.get(el)) clearTimeout(scrollTimers.get(el));
                const idx = nearestIndex(el);
                setSelectedClass(el, idx);
                scrollTimers.set(
                    el,
                    setTimeout(() => {
                        scrollToIndex(el, nearestIndex(el), "smooth");
                        if (onChange)
                            onChange(
                                el.children[nearestIndex(el)].dataset.value,
                            );
                    }, 80),
                );
            }
            function initWheel(el, values, currentValue, onChange) {
                makeWheelItems(el, values);
                let startIdx = 0;
                if (currentValue) {
                    const i = values.indexOf(currentValue);
                    if (i >= 0) startIdx = i;
                }
                scrollToIndex(el, startIdx, "auto");
                setSelectedClass(el, startIdx);
                if (onChange) onChange(values[startIdx]);
                el.addEventListener(
                    "scroll",
                    () => handleScroll(el, onChange),
                    { passive: true },
                );
                el.addEventListener("click", (e) => {
                    const item = e.target.closest(".wheel__item");
                    if (!item) return;
                    const idx = Array.from(el.children).indexOf(item);
                    scrollToIndex(el, idx, "smooth");
                    setSelectedClass(el, idx);
                    if (onChange) onChange(item.dataset.value);
                });
            }

            function openSeatSheet() {
                const cur = seatEl.value.trim();
                let curA = null,
                    curN = null;
                const m = /^([A-K])\-(\d{2})$/.exec(cur);
                if (m) {
                    curA = m[1];
                    curN = m[2];
                }
                tmpArea = curA || AREAS[0];
                tmpNum = curN || NUMS[0];

                initWheel(wheelArea, AREAS, tmpArea, (v) => {
                    tmpArea = v;
                    seatDone.disabled = !(tmpArea && tmpNum);
                });
                initWheel(wheelNum, NUMS, tmpNum, (v) => {
                    tmpNum = v;
                    seatDone.disabled = !(tmpArea && tmpNum);
                });

                seatDone.disabled = !(tmpArea && tmpNum);
                openSheet(seatSheet);
            }
            function closeSeatSheet() {
                closeSheet(seatSheet);
            }

            seatOpen.addEventListener("click", openSeatSheet);
            seatBackdrop.addEventListener("click", closeSeatSheet);
            seatCancel.addEventListener("click", closeSeatSheet);
            seatClear.addEventListener("click", () => {
                tmpArea = null;
                tmpNum = null;
                seatEl.value = "";
                seatDisplay.textContent = "座席を選択";
                seatDisplay.classList.add("muted");
                seatDone.disabled = true;
                updateSummary();
                scrollToIndex(wheelArea, 0, "smooth");
                setSelectedClass(wheelArea, 0);
                scrollToIndex(wheelNum, 0, "smooth");
                setSelectedClass(wheelNum, 0);
            });
            seatDone.addEventListener("click", () => {
                if (!(tmpArea && tmpNum)) return;
                const seatStr = `${tmpArea}-${tmpNum}`;
                seatEl.value = seatStr;
                seatDisplay.textContent = `座席 ${seatStr}`;
                seatDisplay.classList.remove("muted");
                updateSummary();
                closeSeatSheet();
            });

            /* 注文確認シート */
            function buildSummary(container) {
                const items = collectOrderDetailed();
                container.innerHTML = "";
                items.forEach((it) => {
                    const r = document.createElement("div");
                    r.className = "row-brief";
                    const n = document.createElement("div");
                    n.className = "brief-name";
                    n.textContent = it.name;
                    const q = document.createElement("div");
                    q.className = "brief-qty";
                    q.textContent = `×${it.quantity}`;
                    const p = document.createElement("div");
                    p.className = "brief-price";
                    p.textContent = yen(it.total);
                    r.append(n, q, p);
                    container.append(r);
                });
                const total = items.reduce((s, x) => s + x.total, 0);
                const sum = document.createElement("div");
                sum.className = "sumline";
                sum.textContent = `合計 ${yen(total)}`;
                container.append(sum);
            }

            submitBtn.addEventListener("click", () => {
                const items = collectOrderDetailed();
                const seat = seatEl.value.trim();

                if (!items.length) {
                    result.textContent = "数量を入力してください。";
                    result.className = "msg msg--error";
                    return;
                }
                if (!seat) {
                    result.textContent = "座席番号を選択してください。";
                    result.className = "msg msg--error";
                    seatOpen.focus();
                    seatOpen.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                    });
                    return;
                }

                // 確認シートに内容を反映して開く
                confirmSeat.textContent = seat ? `座席 ${seat}` : "";
                buildSummary(confirmList);
                confirmOk.disabled = false;
                confirmOk.textContent = "注文を確定する";
                openSheet(confirmSheet);
            });

            confirmBackdrop.addEventListener("click", () =>
                closeSheet(confirmSheet),
            );
            confirmBack.addEventListener("click", () =>
                closeSheet(confirmSheet),
            );

            confirmOk.addEventListener("click", () => {
                const seat = seatEl.value.trim();
                const items = collectOrderDetailed();
                if (!items.length || !seat) return;

                confirmOk.disabled = true;
                confirmOk.textContent = "送信中…";

                lastOrderSnapshot = {
                    seat,
                    items: items.map((x) => ({ ...x })),
                };

                fetch(`${API_BASE}?action=order`, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=UTF-8" },
                    body: JSON.stringify({
                        seat,
                        items: collectOrderPayload(),
                    }),
                })
                    .then((r) => r.json())
                    .then((res) => {
                        if (!res.ok) throw new Error(res.error || "failed");
                        // 入力をリセット（座席は保持）
                        document
                            .querySelectorAll(".num")
                            .forEach((i) => (i.value = "0"));
                        document.querySelectorAll(".btn").forEach((b) => {
                            if (b.textContent === "−") b.disabled = true;
                        });
                        updateSummary();

                        // 完了シートに反映
                        resultSeat.textContent = lastOrderSnapshot.seat
                            ? `座席 ${lastOrderSnapshot.seat}`
                            : "";
                        buildSummary(resultList);

                        closeSheet(confirmSheet);
                        openSheet(resultSheet);
                    })
                    .catch((err) => {
                        alert(
                            "送信に失敗しました：" +
                                ((err && err.message) || String(err)),
                        );
                        confirmOk.disabled = false;
                        confirmOk.textContent = "注文を確定する";
                    });
            });

            /* 完了シート：戻るで初期画面（一覧）へ */
            resultBackdrop.addEventListener("click", () =>
                closeSheet(resultSheet),
            );
            resultBack.addEventListener("click", () => {
                closeSheet(resultSheet);
                lastOrderSnapshot = null;
                // フォーカスを戻す（アクセシビリティ）
                submitBtn.focus();
            });
        </script>
    </body>
</html>
